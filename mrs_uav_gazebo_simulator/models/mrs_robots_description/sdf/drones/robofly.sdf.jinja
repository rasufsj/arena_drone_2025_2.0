<?xml version="1.0" encoding="utf-8"?>
<sdf version='1.10'>

  {%- import 'mrs_robots_description/sdf/components/component_snippets.sdf.jinja' as components -%}
  {%- import 'mrs_robots_description/sdf/components/generic_components.sdf.jinja' as generic -%}

  {# ================================================================== #}
  {# ||                    parameters definition                     || #}
  {# ================================================================== #}

  {# Robot parameters and arguments {--> #}
  {%- set mass = 0.8 -%} {# [kg] #}
  {%- set prop_mass = 0.002 -%} {# [kg] #}
  {%- set body_radius = 0.15 -%} {# [m] #}
  {%- set body_height = 0.1 -%} {# [m] #}
  {%- set mass_prop = 0.005 -%} {# [kg] #}
  {%- set prop_radius = 0.0635 -%} {# [m] #}
  {%- set prop_height = 0.01 -%} {# [m] #}
  {%- set prop_offset_top = 0.021 -%} {# [m] #}
  {%- set arm_length = 0.135 -%} {# [m] #}
  {%- set root = 'base_link' -%}
  {# <!--}--> #}

  {# Motor constants {--> #}
  {%- set rotor_velocity_slowdown_sim = 20 -%} {# slowdown ratio, only affects simulation visuals #}
  {%- set motor_constant = '6.7e-6' -%} {# [N / (rad/s)^2], compute from max desired thurst at max power #}
  {%- set moment_constant = 0.017 -%} {# [m] ratio between rolling/pitching moment and yawing moment, increase for faster yaw #}
  {%- set time_constant_up = 0.0125 -%} {# [s] how fast props gain speed when throttle goes up #}
  {%- set time_constant_down = 0.025 -%} {# [s] how fast props lose speed when throttle goes down #}
  {%- set max_rot_velocity = 2300 -%} {# [rad/s] max real propeller rotation velocity #}

  {# this should only affect agile drones #}
  {%- set rotor_drag_coefficient = '1.0e-4' -%} {# N / (m/s)^2 how much thrust is lost due to air drag #}
  {%- set rolling_moment_coefficient = '1.0e-6' -%} {# N*m / (m/s^2) rolling moment caused by dragging propellers through the air during forward flight #}
  {# <!--}--> #}

  {# Inertia constants {--> #}
  {%- set inertia_body_radius = 0.20 -%} {# [m] #}
  {%- set inertia_body_height = 0.05 -%} {# [m] #}
  {# <!--}--> #}

  {# Meshes {--> #}

  {# Drone parts {--> #}
  {%- set body_mesh = 'model://mrs_robots_description/meshes/robofly/body.dae' -%}
  {%- set prop_cw_mesh = 'model://mrs_robots_description/meshes/robofly/prop_cw.dae'-%}
  {%- set prop_ccw_mesh = 'model://mrs_robots_description/meshes/robofly/prop_ccw.dae'-%}
  {# <!--}--> #}

  {# Scales {--> #}
  {%- set mesh_scale = '1 1 1' -%}
  {%- set mesh_scale_milimeters = '0.001 0.001 0.001' -%}
  {# <!--}--> #}

  {# <!--}--> #}

  {# Inertias {--> #}
  {%- set body_ixx = mass * (3 * inertia_body_radius * inertia_body_radius + inertia_body_height * inertia_body_height) / 12 -%}
  {%- set body_ixy = 0 -%}
  {%- set body_ixz = 0 -%}
  {%- set body_iyy = mass * (3 * inertia_body_radius * inertia_body_radius + inertia_body_height * inertia_body_height) / 12 -%}
  {%- set body_iyz = 0 -%}
  {%- set body_izz = (mass * inertia_body_radius * inertia_body_radius) / 2 -%}

  {%- set prop_ixx = prop_mass * (3 * prop_radius * prop_radius + prop_height * prop_height) / 12 -%}
  {%- set prop_ixy = 0 -%}
  {%- set prop_ixz = 0 -%}
  {%- set prop_iyy = prop_mass * (3 * prop_radius * prop_radius + prop_height * prop_height) / 12 -%}
  {%- set prop_iyz = 0 -%}
  {%- set prop_izz = (prop_mass * prop_radius * prop_radius) / 2 -%}
  {# <!--}--> #}

  <model name="{{ spawner_args['name'] }}">

    {# ================================================================== #}
    {# ||                    bare body definitions                     || #}
    {# ================================================================== #}

    <link name="{{ root }}">

      <!-- Body visuals {-->

      <!-- Body {-->
      {{ generic.visual_mesh_textured_macro(
        name = 'body',
        mesh_file = body_mesh,
        mesh_scale = mesh_scale_milimeters,
        x = 0,
        y = 0,
        z = 0.000,
        roll = -math.radians(90),
        pitch = 0.0,
        yaw = -math.radians(90),
        )
      }}
      <!--}-->

      <!--}-->

      <!-- Body physics {-->
      {{ generic.multirotor_physics_macro(
        mass = mass,
        body_radius = body_radius,
        body_height = body_height,
        ixx = body_ixx,
        ixy = body_ixy,
        ixz = body_ixz,
        iyy = body_iyy,
        iyz = body_iyz,
        izz = body_izz)
      }}
      <!--}-->

    {# ================================================================== #}
    {# ||                compulsory sensor definitions                 || #}
    {# ================================================================== #}

      <!-- PX4 sensors {-->

      <!-- barometer {-->
      <!-- Noise modeled after BMP390 -->
      {{ generic.barometer_sensor_macro(
        name = "air_pressure",
        update_rate = 50,
        noise_mean = 0,
        noise_std = 3)
      }}
      <!--}-->

      <!-- magnetometer {-->
      <!-- Noise modeled after IIS2MDC -->
      {{ generic.magnetometer_sensor_macro(
        name = "magnetometer",
        update_rate = 100,
        noise_std_x = 0.0001,
        noise_std_y = 0.0001,
        noise_std_z = 0.0001)
      }}
      <!--}-->

      <!-- GPS {-->
      {{ generic.gps_sensor_macro(
        name = "navsat",
        update_rate = 10)
      }}
      <!--}-->

      <!-- IMU {-->
      <!-- Noise modeled after IIM42653 -->
      {{ generic.imu_pixhawk_sensor_macro(
        name = "imu",
        update_rate = 250,
        angular_velocity_noise_mean_x = 0.0,
        angular_velocity_noise_std_x = 0.0008726646,
        angular_velocity_noise_mean_y = 0.0,
        angular_velocity_noise_std_y = 0.0008726646,
        angular_velocity_noise_mean_z = 0.0,
        angular_velocity_noise_std_z = 0.0008726646,
        linear_acceleration_noise_mean_x = 0.0,
        linear_acceleration_noise_std_x = 0.00637,
        linear_acceleration_noise_mean_y = 0.0,
        linear_acceleration_noise_std_y = 0.00637,
        linear_acceleration_noise_mean_z = 0.0,
        linear_acceleration_noise_std_z = 0.00686)
      }}
      <!--}-->

      <!--}-->

    </link>

    {# Propellers {--> #}
    {%- set prop_list = [
    {
    'motor_number': 0,
    'direction': 'ccw',
    'x': arm_length * math.sin(math.radians(45)),
    'y': -arm_length * math.sin(math.radians(45)),
    'z': prop_offset_top,
    'mesh_files': [prop_ccw_mesh],
    'mesh_scale': mesh_scale_milimeters,
    'color': 'DarkGrey'
    },
    {
    'motor_number': 1,
    'direction': 'ccw',
    'x': -arm_length * math.sin(math.radians(45)),
    'y': arm_length * math.sin(math.radians(45)),
    'z': prop_offset_top,
    'mesh_files': [prop_ccw_mesh],
    'mesh_scale': mesh_scale_milimeters,
    'color': 'DarkGrey'
    },
    {
    'motor_number': 2,
    'direction': 'cw',
    'x': arm_length * math.sin(math.radians(45)),
    'y': arm_length * math.sin(math.radians(45)),
    'z': prop_offset_top,
    'mesh_files': [prop_cw_mesh],
    'mesh_scale': mesh_scale_milimeters,
    'color': 'DarkGrey'
    },
    {
    'motor_number': 3,
    'direction': 'cw',
    'x': -arm_length * math.sin(math.radians(45)),
    'y': -arm_length * math.sin(math.radians(45)),
    'z': prop_offset_top,
    'mesh_files': [prop_cw_mesh],
    'mesh_scale': mesh_scale_milimeters,
    'color': 'DarkGrey'
    }
    ]
    -%}
    {{ components.propellers_macro(
      prop_list = prop_list,
      rotor_velocity_slowdown_sim = rotor_velocity_slowdown_sim,
      motor_constant = motor_constant,
      moment_constant = moment_constant,
      parent = root,
      mass = mass_prop,
      radius = prop_radius,
      time_constant_up = time_constant_up,
      time_constant_down = time_constant_down,
      max_rot_velocity = max_rot_velocity,
      rotor_drag_coefficient = rotor_drag_coefficient,
      rolling_moment_coefficient = rolling_moment_coefficient,
      meshes_z_offset = 0,
      prop_ixx = prop_ixx,
      prop_ixy = prop_ixy,
      prop_ixz = prop_ixz,
      prop_iyy = prop_iyy,
      prop_iyz = prop_iyz,
      prop_izz = prop_izz,
      spawner_args = spawner_args)
    }}
    {# <!--}--> #}

    {# ================================================================== #}
    {# ||                  optional sensor definitions                 || #}
    {# ================================================================== #}

    {# Ground truth {--> #}
    {{ components.ground_truth_macro(
      parent_link = root,
      x = 0,
      y = 0,
      z = 0,
      roll = 0,
      pitch = 0,
      yaw = 0,
      spawner_args = spawner_args)
    }}
    {# <!--}--> #}

    {# ========================== camera sensors ======================== #}

    {# camera_front {--> #}

    {%- macro camera_front_macro(spawner_args) -%}

      {%- set spawner_keyword = 'enable-camera-front' -%}
      {%- set spawner_description = 'Enable front-facing camera' -%}
      {%- set spawner_default_args = {'rate': 20, 'noise': 0.007} -%}

      {%- if spawner_keyword in spawner_args.keys() -%}
        {{ generic.handle_spawner_args(spawner_keyword, spawner_default_args, spawner_args) }}

        {{ generic.camera_macro_meshless(
          parent_link = root,
          camera_name = 'camera_front',
          parent_frame_name = spawner_args['name'] + '/fcu',
          camera_frame_name = spawner_args['name'] + '/camera_front_optical',
          sensor_base_frame_name = spawner_args['name'] + '/camera_front',
          camera_topic_name = spawner_args['name'] + '/camera_front',
          frame_rate = spawner_args[spawner_keyword]['rate'],
          horizontal_fov = 0.79622,
          image_width = 728,
          image_height = 544,
          min_distance = 0.02,
          max_distance = 80,
          noise_mean = 0.0,
          noise_stddev = spawner_args[spawner_keyword]['noise'],
          x_offset = 0.1,
          y_offset = 0.0,
          z_offset = 0.02143,
          roll_offset = 0,
          pitch_offset = 0,
          yaw_offset = 0)
        }}

      {%- endif -%}

    {%- endmacro -%}

    {{ camera_front_macro(
      spawner_args = spawner_args)
    }}

    {# <!--}--> #}

    {# camera_down {--> #}

    {%- macro camera_down_macro(spawner_args) -%}

      {%- set spawner_keyword = 'enable-camera-down' -%}
      {%- set spawner_description = 'Enable down-facing camera' -%}
      {%- set spawner_default_args = {'rate': 20, 'noise': 0.007} -%}

      {%- if spawner_keyword in spawner_args.keys() -%}
        {{ generic.handle_spawner_args(spawner_keyword, spawner_default_args, spawner_args) }}

        {{ generic.camera_macro_meshless(
          parent_link = root,
          camera_name = 'camera_down',
          parent_frame_name = spawner_args['name'] + '/fcu',
          camera_frame_name = spawner_args['name'] + '/camera_down_optical',
          sensor_base_frame_name = spawner_args['name'] + '/camera_down',
          camera_topic_name = spawner_args['name'] + '/camera_down',
          frame_rate = spawner_args[spawner_keyword]['rate'],
          horizontal_fov = 1.5476,
          image_width = 1280,
          image_height = 800,
          min_distance = 0.02,
          max_distance = 80,
          noise_mean = 0.0,
          noise_stddev = spawner_args[spawner_keyword]['noise'],
          x_offset = 0.0821,
          y_offset = 0.0,
          z_offset = -0.01,
          roll_offset = 3.14,
          pitch_offset = 1.57,
          yaw_offset = 0.0)
        }}

      {%- endif -%}

    {%- endmacro -%}

    {{ camera_down_macro(
      spawner_args = spawner_args)
    }}

    {# <!--}--> #}

  </model>

</sdf>
